<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TOTP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f9f9f9;
      text-align: center;
    }
    p {
      margin: 8px 0;
      color: #666;
    }
    input {
      border: 1px solid #ccc;
      width: 90%;
      max-width: 360px;
      outline: none;
      color: #333;
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
    }
    #webCode {
      font-size: 48px;
      font-weight: bold;
      cursor: pointer;
      margin: 12px 0;
      color: #222;
      user-select: none;
    }
    #webRefresh {
      color: red;
      font-size: 18px;
      margin-top: 6px;
    }
    #copyMsg {
      color: green;
      font-size: 14px;
      margin-top: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <input type="text" id="webSec" placeholder="Secret">
  
  <div id="webCode">123456</div>
  <div id="copyMsg">✅ OK</div>
  
  <p>Expire</p>
  <div id="webRefresh">2</div>

  <script>
    const webCode = document.getElementById("webCode");
    const copyMsg = document.getElementById("copyMsg");

    webCode.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(webCode.textContent);
        copyMsg.style.display = "block";
        setTimeout(() => copyMsg.style.display = "none", 500);
      } catch (err) {
        alert("Error: " + err);
      }
    });
  </script>
</body>
</html>
<script>
  let t = null;
  let k = '';
  let lastCode = '';
  let isprivate = false;

  function key2code(K,t) {
    function sha1(C){
      function L(x,b){return x<<b|x>>>32-b;}
      var l=C.length,D=C.concat([1<<31]),V=0x67452301,W=0x88888888,
        Y=271733878,X=Y^W,Z=0xC3D2E1F0;W^=V;
      do D.push(0);while(D.length+1&15);D.push(32*l);
      while (D.length){
        var E=D.splice(0,16),a=V,b=W,c=X,d=Y,e=Z,f,k,i=12;
        function I(x){var t=L(a,5)+f+e+k+E[x];e=d;d=c;c=L(b,30);b=a;a=t;}
        for(;++i<77;)E.push(L(E[i]^E[i-5]^E[i-11]^E[i-13],1));
        k=0x5A827999;for(i=0;i<20;I(i++))f=b&c|~b&d;
        k=0x6ED9EBA1;for(;i<40;I(i++))f=b^c^d;
        k=0x8F1BBCDC;for(;i<60;I(i++))f=b&c|b&d|c&d;
        k=0xCA62C1D6;for(;i<80;I(i++))f=b^c^d;
        V+=a;W+=b;X+=c;Y+=d;Z+=e;
      }
      return[V,W,X,Y,Z];
    }
    var k=[],l=[],i=0,j=0,c=0;
    for (;i<K.length;){
      c=c*32+'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567'.
      indexOf(K.charAt(i++).toUpperCase());
      if((j+=5)>31)k.push(Math.floor(c/(1<<(j-=32)))),c&=31;
    }
    j&&k.push(c<<(32-j));
    for(i=0;i<16;++i)l.push(0x6A6A6A6A^(k[i]=k[i]^0x5C5C5C5C));
    var s=sha1(k.concat(sha1(l.concat([0,t])))),o=s[4]&0xF;
    return (((s[o>>2]<<8*(o&3)|(o&3?s[(o>>2)+1]>>>8*(4-o&3):0))&-1>>>1)%1000000).toString().padStart(6, "0");
  }

  function update() {
    var e = Math.floor(new Date().getTime()/1000);
    var t = Math.floor(e/30);
    let left = 30 - (e - (t*30));
    // 若 k 為空白或非 base32，key2code 可能會失敗 -> 簡單處理：只在有 k 時計算
    let c = k ? key2code(k, t) : '------';
    if (lastCode != c) document.querySelector('#webCode').innerHTML = c;
    lastCode = c;
    document.querySelector('#webRefresh').innerHTML = left;
  }

  // 以 URLSearchParams 解析查詢參數（更穩健）
  const params = new URLSearchParams(window.location.search);
  // 優先支援 code，備援支援 c（兼容舊參數）
  let raw = params.get('code') || params.get('c') || '';
  // 解碼並移除空白，若有 fragment (#...) 則不包含
  try { raw = raw ? decodeURIComponent(raw) : raw; } catch(e) {}
  raw = raw.replace(/\s+/g, '');
  k = raw;
  document.querySelector('#webSec').value = k;

  // private 參數明確比對值 '1'
  isprivate = params.get('private') === '1';

  // 立刻更新一次，並每秒更新
  update();
  setInterval(update, 1000);

  const onSecretUpdate = (e) => {
    k = e.target.value.trim();
    k = k.replace(/\s+/g, '');
    e.target.value = k;
    // 只有非 private 情況下才把 secret 寫入 URL（且 encode）
    if (!isprivate) {
      const newQuery = '?code=' + encodeURIComponent(k);
      window.history.pushState({state:1}, document.title, newQuery);
    }
    update();
  };

  const secInput = document.querySelector('#webSec');
  secInput.addEventListener('keyup', onSecretUpdate);
  secInput.addEventListener('input', onSecretUpdate);
  secInput.addEventListener('focus', e => e.target.setSelectionRange(0, e.target.value.length));
</script>
