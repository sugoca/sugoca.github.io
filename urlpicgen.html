<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Img Gen</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f8f9fa;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 16px;
      resize: vertical;
    }

    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .image-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      text-align: center;
      cursor: move;
    }

    .image-container.dragging {
      opacity: 0.5;
    }

    .image-container img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
    }

    .caption {
      padding: 0.5rem;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <textarea id="urlInput" placeholder="每行輸入圖片網址（可選加 | 標題）"></textarea>
  <div id="gallery"></div>

  <script>
    function extractFilename(url) {
      try {
        const anchor = document.createElement('a');
        anchor.href = url;
        const path = anchor.pathname;
        const file = path.substring(path.lastIndexOf("/") + 1).split('?')[0];
        return file || "未命名圖片";
      } catch {
        return "未命名圖片";
      }
    }

    function generateGallery() {
      const input = document.getElementById("urlInput").value;
      const lines = input
        .split("\n")
        .map((line) => line.trim())
        .filter((line) => line !== "");
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      lines.forEach((line, index) => {
        const [urlPart, captionPart] = line.split("|").map(part => part.trim());
        const url = urlPart;
        if (!/^https?:\/\//i.test(url)) return;

        const caption = captionPart || extractFilename(url);

        const container = document.createElement("div");
        container.className = "image-container";
        container.draggable = true;
        container.dataset.index = index;

        const img = document.createElement("img");
        img.src = url;
        img.loading = "lazy";
        img.alt = caption;
        img.onerror = function () {
          this.onerror = null;
          this.src = "https://via.placeholder.com/300x200?text=載入失敗";
        };

        container.appendChild(img);

        const captionElem = document.createElement("div");
        captionElem.className = "caption";
        captionElem.textContent = caption;
        container.appendChild(captionElem);

        // 拖曳事件
        container.addEventListener("dragstart", (e) => {
          container.classList.add("dragging");
          e.dataTransfer.setData("text/plain", container.dataset.index);
        });

        container.addEventListener("dragend", () => {
          container.classList.remove("dragging");
        });

        container.addEventListener("dragover", (e) => {
          e.preventDefault();
          const draggingElem = document.querySelector(".dragging");
          if (draggingElem && draggingElem !== container) {
            const children = [...gallery.children];
            const currentIndex = children.indexOf(container);
            const draggingIndex = children.indexOf(draggingElem);
            if (draggingIndex < currentIndex) {
              gallery.insertBefore(draggingElem, container.nextSibling);
            } else {
              gallery.insertBefore(draggingElem, container);
            }
          }
        });

        gallery.appendChild(container);
      });
    }

    // 輸入時即時產生圖片（含防抖處理）
    let debounceTimer;
    document.getElementById("urlInput").addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(generateGallery, 300);
    });
  </script>
</body>
</html>
